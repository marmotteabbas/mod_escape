define(["jquery"],function(a){function b(a,b){fetch(a,{method:"head"}).then(function(a){b(a.ok)})}var c=!0,d=0;return{init:function(e){a(".fp-content").bind("DOMSubtreeModified",function(){var d=a(".realpreview").attr("src");b(d,function(b){b&&c&&(c=!1,a.ajax({method:"POST",url:e+"/mod/escape/get_url_image_ajax.php",data:{themid:a("input[name=mediafile]").val()}}).done(function(b){var c=new Image;c.src=b,a(c).one("load",function(){var d=c.width,e=c.height;if(d>600){var f=600/d;e*=f,d=600}a("#image_container").html("<div class='col-md-3'></div><div class='col-md-9 form-inline felement'>"+'<svg id="svg_viewer" class="svg_viewer" height="'+e+'" width="'+d+'" onclick="require(\'mod_escape/img_manager\').coordsandintro(event)"><image xlink:href="'+b+'" x="0" y="0"/ style="width: '+d+"px;\"></svg></div><div class='col-md-3'></div><div class='col-md-9 form-inline felement'><span style='color: blue;cursor: pointer;' id='erase'>Erase All</span></div>"),a("#id_contents_editor").html('<svg id="svg_viewer" class="svg_viewer" height="'+e+'" width="'+d+'" onclick="require(\'mod_escape/img_manager\').coordsandintro(event)"><image xlink:href="'+b+'" x="0" y="0"/ style="width: '+d+'px;"></svg>'),a("#id_contents_editoreditable").html(a("#svg_viewer")[0].outerHTML),a("#erase").click(function(){require("mod_escape/img_manager").eraseall()})})}))})}),a("#id_introduction").on("input paste",function(){a("#id_contents_editoreditable").html("<span id='intro_text_clicking_pix'>"+a("#id_introduction").val()+"</span><br />"+a("#svg_viewer")[0].outerHTML),a("#id_contents_editor").html("<span id='intro_text_clicking_pix'>"+a("#id_introduction").val()+"</span><br />"+a("#svg_viewer")[0].outerHTML),a("#editor_atto_content_wrap").html("<span id='intro_text_clicking_pix'>"+a("#id_introduction").val()+"</span><br />"+a("#svg_viewer")[0].outerHTML)}),a("#id_contents_editor").text().includes("svg")&&(a("#image_container").html("<div class='col-md-3'></div><div class='col-md-9 form-inline felement'>"+a("#id_contents_editor").text()+"</div><div class='col-md-3'></div><div class='col-md-9 form-inline felement'><span style='color: blue;cursor: pointer;' id='erase'>Erase All</span></div>"),a("#id_contents_editoreditable").html(a("#svg_viewer")[0].outerHTML),a("#erase").click(function(){require("mod_escape/img_manager").eraseall()})),a("#svg_viewer").children().length-1>0&&(d=a("#svg_viewer").children().length-1),a("#id_introduction").val(a("#image_container #intro_text_clicking_pix").html()),a("#image_container #intro_text_clicking_pix").remove()},coordsandintro:function(b){require("mod_escape/img_manager").coords(b),a("#id_contents_editoreditable").html("<span id='intro_text_clicking_pix'>"+a("#id_introduction").val()+"</span><br />"+a("#svg_viewer")[0].outerHTML),a("#id_contents_editor").html("<span id='intro_text_clicking_pix'>"+a("#id_introduction").val()+"</span><br />"+a("#svg_viewer")[0].outerHTML),a("#editor_atto_content_wrap").html("<span id='intro_text_clicking_pix'>"+a("#id_introduction").val()+"</span><br />"+a("#svg_viewer")[0].outerHTML)},coords:function(b){if(d<5){var c=b.clientX,e=b.clientY,f=document.getElementById("svg_viewer"),g=require("mod_escape/img_manager").elementPosition(f);c-=g.viewportX,e-=g.viewportY,f.innerHTML=f.innerHTML+'<circle cx="'+c+'" cy="'+e+'" r="10" stroke="#4b6c0b" fill="#9dcc41" class="puce"></circle>',a("#id_contents_editoreditable").html(a("#svg_viewer")[0].outerHTML),a("#id_contents_editor").html(a("#svg_viewer")[0].outerHTML),a("#editor_atto_content_wrap").html(a("#svg_viewer")[0].outerHTML),a("#id_answer_editor_"+d).val("("+c+","+e+")"),d++}},elementPosition:function(a){var b=a.getBoundingClientRect();return{clientX:a.offsetLeft,clientY:a.offsetTop,viewportX:b.x||b.left,viewportY:b.y||b.top}},eraseall:function(){a(".puce").remove();for(var b=0;b<=d;b++)a("#id_answer_editor_"+b).val("");d=0;var c=document.getElementById("svg_viewer");a("#id_contents_editor").html(c.innerHTML)}}});